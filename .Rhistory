legend.position = "bottom",
panel.background = element_rect(fill = "white", color = NA),
panel.border = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
strip.background = element_rect(fill = "grey95", color = "black"),
strip.text.x = element_text(size = 16, color = "black"),
strip.text.y = element_text(size = 16, color = "black"))
theme_facet <- theme_classic() +
theme(
axis.text = element_text(size = 11, color = "black"),
axis.title = element_text(size = 16, color = "black"),
axis.title.y = element_text(vjust = 1.5, color = "black"),
axis.line = element_line(color = "black"),
legend.position = "bottom",
panel.background = element_rect(fill = "white", color = NA),
panel.border = element_rect(fill = NA, color = "black"),
panel.grid.major = element_line(color = "grey85"),
panel.grid.minor = element_blank(),
strip.background = element_rect(fill = "grey95", color = "black"),
strip.text.x = element_text(size = 16, color = "black"),
strip.text.y = element_text(size = 16, color = "black"))
# other options ----
knitr::opts_chunk$set(
tidy = FALSE,
message = FALSE,
warning = FALSE)
options(htmltools.dir.version = FALSE)
# Chunk 3
# load libraries ----
# documentation
library(knitr)
# eDNA analysis
library(dada2)
# wrangling
library(tidyr)
library(dplyr)
library(tibble)
library(readr)
library(glue)
# visualization
library(ggplot2)
library(ggthemes)
library(plotly)
library(patchwork)
# Chunk 4
# designate file paths ----
# create variable with initially trimmed reads
raw <- "data/seq/raw"
# path for filtered reads
filt <- "data/seq/filt"
# create lists of matched forward & reverse fastq files ----
# forward reads
fnFs <- sort(list.files(raw, pattern = "_R1.fastq", full.names = TRUE))
# reverse reads
fnRs <- sort(list.files(raw, pattern = "_R2.fastq", full.names = TRUE))
# create vector with sample names
sample.names <- substr(basename(fnFs), 1, (nchar(fnFs)-25))
# create file names & paths for filtered reads ----
# named vectors of forward reads
filtFs <- file.path(filt, glue("{sample.names}_R1.fastq.gz"))
names(filtFs) <- sample.names
# named vectors of reverse reads
filtRs <- file.path(filt, glue("{sample.names}_R2.fastq.gz"))
names(filtRs) <- sample.names
# Chunk 5: fig-err-forw
#| label: fig-err-forw
#| fig-cap: "Quality scores for the forward reads of the first sample. Grey-scale underlying heatmap shows frequency of each score at each base position (darker color is higher frequency), green line is em quality score for base position, orange lines indicate the quartiles (solid is median, dashed = 25th and 75th quartile). The red line indicates the percentage of reads that extend to at least that position."
#| fig-height: 9
ggplotly(plotQualityProfile(fnFs[1]))
# Chunk 6: fig-err-rev
#| label: fig-err-rev
#| fig-cap: "Quality scores for the reverse reads in 12th sample. Grey-scale underlying heatmap shows frequency of each score at each base position (darker color is higher frequency), green line is median quality score for base position, orange lines indicate the quartiles (solid is median, dashed = 25th and 75th quartile). The red line indicates the percentage of reads that extend to at least that position."
#| fig-height: 9
#| echo: false
ggplotly(plotQualityProfile(fnRs[12]))
# Chunk 7
# filter reads
out <- filterAndTrim(fnFs, filtFs, fnRs, filtRs, #
truncLen = c(280, 280),     #
trimLeft = c(18, 2),        #
truncQ = 6,                 #
maxEE = c(2,2),             #
minLen = 35,                #
rm.phix = TRUE,             #
matchIDs = FALSE,           #
compress = TRUE)            #
# Chunk 9: tbl-filt-results
#| label: tbl-filt-results
#| tbl-cap: "Mean and standard deviation of the proportion of reads lost due to quality filtering and the mean and standard deviation of the number of remaining reads per sample post filtering."
#| echo: false
# summarize proportion of reads lost during trimming
check <- as.data.frame(out) %>%
mutate(perc_lost = 100-(reads.out/reads.in*100)) %>%
summarize(mean_loss = mean(perc_lost),
std_loss = sd(perc_lost),
mean_reads = mean(reads.out),
std_reads = sd(reads.out))
kable(
check
)
# Chunk 10: fig-err-for-fil
#| label: fig-err-for-fil
#| fig-cap: "Quality scores of forward reads for 16 random samples in the data set after trimming. Grey-scale underlying heatmap shows frequency of each score at each base position (darker color is higher frequency), green line is median quality score for base position, orange lines indicate the quartiles (solid is median, dashed = 25th and 75th quartile). The read line indicates the percentage of reads that extend to at least that position."
#| fig-height: 9
#| echo: false
ggplotly(plotQualityProfile(filtFs[4]))
# Chunk 11: fig-err-rev-fil
#| label: fig-err-rev-fil
#| fig-cap: "Quality scores of reverse reads for 12 random samples in the data set after trimming. Grey-scale underlying heatmap shows frequency of each score at each base position (darker color is higher frequency), green line is median quality score for base position, orange lines indicate the quartiles (solid is median, dashed = 25th and 75th quartile). The read line indicates the percentage of reads that extend to at least that position."
#| fig-height: 9
#| echo: false
ggplotly(plotQualityProfile(filtRs[4]))
# Chunk 12
#| cache: true
# forward reads
errF <- learnErrors(filtFs,               #
nbases = 1e8,         #
multithread = FALSE)  #
# reverse reads
errR <- learnErrors(filtRs,
nbases = 1e8,
multithread = FALSE)
# Chunk 13: fig-err-rates
#| label: fig-err-rates
#| fig-cap: "Error rates for each possible transition for forward (top) and reverse reads (bottom). Observed (grey points) and estimated (black line) error rates for each consensus quality score. Expected error rates for nominal definition of the quality score are in red."
#| fig-height: 15
# Visualize estimated error
p1 <- plotErrors(errF, nominalQ = TRUE)
p2 <- plotErrors(errR, nominalQ = TRUE)
p1 / p2
# Chunk 14
#| results: hide
derepFs <- lapply(filtFs,
derepFastq,
verbose = FALSE)
derepRs <- lapply(filtRs,
derepFastq,
verbose = FALSE)
# Chunk 15
#| results: hide
dadaFs <- dada(derepFs,
err = errF,
selfConsist = FALSE,
multithread = TRUE)
dadaRs <- dada(derepRs,
err = errR,
selfConsist = FALSE,
multithread = TRUE)
# Chunk 16
#| results: hide
mergeASVs <- mergePairs(dadaFs, filtFs,
dadaRs, filtRs,
minOverlap = 12,
maxMismatch = 0)
# Chunk 17
head(mergeASVs[1])
# Chunk 18
# Largest overlap
max(mergeASVs[[1]]$nmatch)
# Smallest overlap
min(mergeASVs[[1]]$nmatch)
# Chunk 19
seqtab <- makeSequenceTable(mergeASVs)
# Chunk 20
dim(seqtab)
seqtab[,1]
# Chunk 21
seqtab.nochim <- removeBimeraDenovo(seqtab,
method = "consensus",
multithread = FALSE,
verbose = TRUE)
# Chunk 22: fig-seq-length-ASV
#| label: fig-seq-length-ASV
#| fig-cap: "Distribution of sequence length for merged ASVs. The red dotted line indicates sequences that are 100-105bp long. We are targeting a 106 bp amplicon and are using 2x150 bp sequencing. Primer sites are approx 25bp each. "
#| echo: false
getSequences(seqtab) %>%
nchar() %>%
as.data.frame() %>%
ggplot(aes(x = .)) +
geom_histogram(binwidth = 5, color = "black", fill = "darkorange") +
labs(x = "sequence length", y = "number of unique sequences") +
theme_standard
# custom function to get read numbers
getN <- function(x) sum(getUniques(x))
# create data table with number of reads per sample at each step
track <- cbind(out, sapply(dadaFs, getN), sapply(dadaRs, getN), sapply(mergeASVs, getN), rowSums(seqtab.nochim)) %>%
as.data.frame() %>%
rownames_to_column("sample") %>%
rename(trimmed = reads.out,
denoisedF = V3,
denoisedR = V4,
merged = V5,
rm_chimera = V6) %>%
pivot_longer(names_to = "filter", values_to = "reads", cols = 2:7) %>%
mutate(filter = ordered(filter, levels = c("reads.in", "trimmed", "denoisedF", "denoisedR", "merged", "rm_chimera")),
k_reads = reads/1000)
# plot distribution
ggplot(track, aes(x = filter, y = k_reads)) +
geom_boxplot(fill = "darkorange") +
labs(x = "filter/processing step", y = "thousand reads per sample") +
theme_standard
#| label: setup
#| include: false
# custom functions ----
library(ggplot2)
theme_standard <- theme_classic() +
theme(
axis.text = element_text(size = 11, color = "black"),
axis.title = element_text(size = 16, color = "black"),
axis.title.y = element_text(vjust = 1.5, color = "black"),
axis.line = element_line(color = "black"),
legend.position = "bottom",
panel.background = element_rect(fill = "white", color = NA),
panel.border = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
strip.background = element_rect(fill = "grey95", color = "black"),
strip.text.x = element_text(size = 16, color = "black"),
strip.text.y = element_text(size = 16, color = "black"))
theme_facet <- theme_classic() +
theme(
axis.text = element_text(size = 11, color = "black"),
axis.title = element_text(size = 16, color = "black"),
axis.title.y = element_text(vjust = 1.5, color = "black"),
axis.line = element_line(color = "black"),
legend.position = "bottom",
panel.background = element_rect(fill = "white", color = NA),
panel.border = element_rect(fill = NA, color = "black"),
panel.grid.major = element_line(color = "grey85"),
panel.grid.minor = element_blank(),
strip.background = element_rect(fill = "grey95", color = "black"),
strip.text.x = element_text(size = 16, color = "black"),
strip.text.y = element_text(size = 16, color = "black"))
# set options
knitr::opts_chunk$set(
tidy = FALSE,
message = FALSE,
warning = FALSE)
options(htmltools.dir.version = FALSE)
# read csv file
temperature <- read_delim("data/GLB.Ts+dSST.csv", delim = ",")
# documentation
library(knitr)
# wrangling
library(tidyr)
library(dplyr)
library(tibble)
library(readr)
library(glue)
# visualization
library(ggplot2)
library(ggthemes)
library(plotly)
library(patchwork)
# read csv file
temperature <- read_delim("data/GLB.Ts+dSST.csv", delim = ",")
# read csv file skipping the first line
temperature <- read_delim("data/GLB.Ts+dSST.csv", delim = ",", skip = 1)
# check that dataframe is in order
head(temperature)
temperature <- temperature %>%
replace(. == "***", NA) %>%
mutate_if(is.character, as.numeric)
ggplot(temperature, aes(x = Year, y = `J-D`)) +
geom_line(color = "blue", size = 1) +
geom_smooth(color = "red", size = 1.5, se = FALSE) +
labs(x = "year", y = "temperature anomaly [C]",
title = "Annual mean global surface temperature relative to 1951-1980 average.",
caption = "source: NASA Goddard Institute for Space Studies") +
theme_standard
ggplot(temperature, aes(x = Year, y = `J-D`)) +
geom_line(color = "blue", size = 1) +
geom_smooth(color = "red", size = 1.5, se = FALSE) +
geom_hline(yintercept = 0, line_type = "dotted") +
labs(x = "year", y = "temperature anomaly [C]",
title = "Annual mean global surface temperature relative to 1951-1980 average.",
caption = "source: NASA Goddard Institute for Space Studies") +
theme_standard
ggplot(temperature, aes(x = Year, y = `J-D`)) +
geom_line(color = "blue", size = 1) +
geom_smooth(color = "red", size = 1.5, se = FALSE) +
geom_hline(yintercept = 0, type = "dotted") +
labs(x = "year", y = "temperature anomaly [C]",
title = "Annual mean global surface temperature relative to 1951-1980 average.",
caption = "source: NASA Goddard Institute for Space Studies") +
theme_standard
ggplot(temperature, aes(x = Year, y = `J-D`)) +
geom_line(color = "blue", size = 1) +
geom_smooth(color = "red", size = 1.5, se = FALSE) +
geom_hline(yintercept = 0, line = "dotted") +
labs(x = "year", y = "temperature anomaly [C]",
title = "Annual mean global surface temperature relative to 1951-1980 average.",
caption = "source: NASA Goddard Institute for Space Studies") +
theme_standard
ggplot(temperature, aes(x = Year, y = `J-D`)) +
geom_line(color = "blue", size = 1) +
geom_smooth(color = "red", size = 1.5, se = FALSE) +
geom_hline(yintercept = 0, style = "dotted") +
labs(x = "year", y = "temperature anomaly [C]",
title = "Annual mean global surface temperature relative to 1951-1980 average.",
caption = "source: NASA Goddard Institute for Space Studies") +
theme_standard
ggplot(temperature, aes(x = Year, y = `J-D`)) +
geom_line(color = "blue", size = 1) +
geom_smooth(color = "red", size = 1.5, se = FALSE) +
geom_hline(yintercept = 0, type = "dotted") +
labs(x = "year", y = "temperature anomaly [C]",
title = "Annual mean global surface temperature relative to 1951-1980 average.",
caption = "source: NASA Goddard Institute for Space Studies") +
theme_standard
ggplot(temperature, aes(x = Year, y = as.numeric(`J-D`))) +
geom_line(color = "blue", size = 1) +
geom_smooth(method = "lm", color = "red", size = 1, se = FALSE) +
labs(x = "year", y = "temperature anomaly [C]",
title = "Annual mean global surface temperature relative to 1951-1980 average.",
caption = "source: NASA Goddard Institute for Space Studies")
ggplot(temperature, aes(x = Year, y = `J-D`)) +
geom_line(color = "blue", size = 1) +
labs(x = "year", y = "temperature anomaly [C]",
title = "Annual mean global surface temperature relative to 1951-1980 average.",
caption = "source: NASA Goddard Institute for Space Studies") +
theme_standard
ggplot(temperature, aes(x = Year, y = `J-D`)) +             # define data set and columns to plot on x and y axis
geom_line(color = "blue", size = 1) +                     # plot line plot
labs(x = "year", y = "temperature anomaly [C]",           # determine labels
title = "Annual mean global surface temperature relative to 1951-1980 average.",
caption = "source: NASA Goddard Institute for Space Studies")
ggplot(temperature, aes(x = Year, y = as.numeric(`J-D`))) +
geom_line(color = "blue", size = 1) +
geom_smooth(method = "lm", color = "red", size = 1, se = FALSE) +
labs(x = "year", y = "temperature anomaly [C]",
title = "Annual mean global surface temperature relative to 1951-1980 average.",
caption = "source: NASA Goddard Institute for Space Studies") +
theme_standard
# fit linear regression
score_model <- lm(`J-D` ~ Year, data = temperature)
# view summary of results
summary(score_model)
# Chunk 1: setup
#| label: setup
#| include: false
# set options
knitr::opts_chunk$set(
tidy = FALSE,
message = FALSE,
warning = FALSE)
options(htmltools.dir.version = FALSE)
# Chunk 3
# load libraries
library(phyloseq)
library(vegan)
library(knitr)
library(tidyverse)
# Chunk 4
# load sample data
soil <- read_delim("data/soil.csv", delim = ";")
# Chunk 5
# create phyloseq object
load(file = "data/ps.rdata")
# Chunk 6
ntaxa(ps)
# Chunk 7
ps_fungi <- subset_taxa(ps, Kingdom == "k__Fungi")
# Chunk 8
ps_fungi_nosd <- filter_taxa(ps_fungi, function(x) sum(x) > 2, TRUE)
# Chunk 9
ps_fungi_nosd_hel <- transform_sample_counts(ps_fungi_nosd, function(x) sqrt(x/sum(x)))
# Chunk 10
ps_transf = tax_glom(ps_fungi_nosd_hel, "Species", NArm = FALSE)
# Chunk 11
otu_table(ps_transf)[1:2, 1:2]
tax_table(ps_transf)[1:2, 1:2]
asv_tax <- tax_table(ps_transf) %>%  #
as.data.frame() %>%            #
rownames_to_column("asv")      #
# write out intermin file
write_delim(asv_tax, "results/asv_tax.txt", delim = "\t")
# write out interim file
write_delim(asv_counts, "results/asv_tax.txt", delim = "\t")
asv_counts <- otu_table(ps_transf) %>%  #
t() %>%                               #
as.data.frame() %>%                   #
rownames_to_column("asv")             #
# write out interim file
write_delim(asv_counts, "results/asv_tax.txt", delim = "\t")
# write out interim file
write_delim(asv_counts, "results/asv_tax.txt", delim = "\t")
asv_tax <- tax_table(ps_transf) %>%  #
as.data.frame() %>%            #
rownames_to_column("asv")      #
# write out interim file
write_delim(asv_tax, "results/asv_tax.txt", delim = "\t")
asv_counts <- otu_table(ps_transf) %>%  #
t() %>%                               #
as.data.frame() %>%                   #
rownames_to_column("asv")             #
# write out interim file
write_delim(asv_counts, "results/asv_counts.txt", delim = "\t")
# fit linear regression
score_model <- lm(`J-D` ~ Year, data = temperature)
# view summary of results
summary(score_model)
CO2 <- read_delim("data/co2_annmean_mlo.csv", delim = ",", skip = 55)
head(CO2)
#| label: fig-CO2-temp-comparison
#| fig-cap: "Comparison of increase in mean global temperature anomaly relative to 1951-1980 (left) and increase in mean atmospheric CO2 concenttrations (right panel) measured a Mauna Loa Observatory. Regression lines indicating temporal trend included in red."
#| fig-height: 4
#| echo: false
p1 <- temperature %>%
filter(Year >= 1959) %>%
ggplot(aes(x = Year, y = `J-D`)) +
geom_line(color = "blue", size = 1.5) +
geom_smooth(color = "red", size = 1, se = FALSE) +
labs(x = "year", y = "temperature anomaly [C]",
caption = "source: NASA Goddard Institute for Space Studies") +
theme_standard
p2 <- ggplot(CO2, aes(x = year, y = mean)) +
geom_line(color = "blue", size = 1.5) +
geom_smooth(color = "red", size = 1, se = FALSE) +
labs(x = "year", y = "mean atmospheric CO2 [ppm]",
caption = "source: Global Monitoring Laboratry/NOAA") +
theme_standard
p1 + p2
# define url
url <- "http://cdiac.ess-dive.lbl.gov/ftp/trends/temp/vostok/vostok.1999.temp.dat"
# download file
download.file(url, "data/vostok_temp.txt")
# load dataset
vostok_temp <- read_table2("data/vostok_temp.txt",
skip = 60,
col_names = c("depth", "age_ice", "deuterium", "temperature"))
rm(vostock_temp)
rm(vostok_temp)
# load dataset
vostok_temp <- read_table("data/vostok_temp.txt",
skip = 60,
col_names = c("depth", "age_ice", "deuterium", "temperature"))
View(vostok_temp)
# load dataset
vostok_temp <- read_table2("data/vostok_temp.txt",
skip = 60,
col_names = c("depth", "age_ice", "deuterium", "temperature"))
vostok_temp
# define url
url <- "http://cdiac.ess-dive.lbl.gov/ftp/trends/temp/vostok/vostok.1999.temp.dat"
# download file
download.file(url, "data/vostok_temp.txt")
# load dataset
vostok_temp <- read_table2("data/vostok_temp.txt",
skip = 60,
col_names = c("depth", "age_ice", "deuterium", "temperature"))
#| label: fig-vostock-temp
#| fig-cap: "Temperature variation during glacial/interglacial periods derived from air bubbles in Vostock ice cores."
#| fig-height: 6
#| echo: false
ggplot(vostok_temp, aes(x = age_ice/1000, y = temperature)) +
geom_line(color = "blue", size = 1) +
labs(x = "thousand years before present", y = "Temperature variation [C]",
title = "Temperature variation during glacial/interglacial periods",
caption = "Data: Carbon Dioxide Information Analysis Center (CDIAC)") +
theme_standard
#| label: fig-lin-reg-vostock-temp
#| fig-cap: "Change in temperature during glacial/interglacial periods derived from Vostok ice cores (blue) with fitted linear regression (red)."
#| fig-width: 10
#| fig-height: 6
#| echo: false
ggplot(vostok_temp, aes(x = age_ice/1000, y = temperature)) +
geom_line(color = "blue", size = 1) +
geom_smooth(method = "lm", color = "red", se = FALSE) +
labs(x = "thousand years before present", y = "Temperature variation [C]",
title = "Temperature derived from Vostok ice core, Antarctica.",
caption = "Data: Carbon Dioxide Information Analysis Center (CDIAC)") +
theme_standard
# fit linear regression
score_model <- lm(temperature ~ age_ice, data = vostok_temp)
# view summary of results
summary(score_model)
# fit linear regression
score_model <- lm(temperature ~ age_ice, data = vostok_temp)
# view summary of results
summary(score_model)
p1 <- ggplot(vostok_temp, aes(x = age_ice/1000, y = temperature)) +
geom_line(color = "blue", size = .75) +
labs(x = "thousand years before present", y = "Temperature variation [C]",
caption = "Data: Carbon Dioxide Information Analysis Center (CDIAC)")
ggplotly(p1)
#| label: fig-temp-subset
#| fig-cap: "Temperature trends (linear regression, red) recorded in Vostok ice core for time period from approx. 138 - 128 kyrs before present."
#| echo: false
# define time range
min_year_vostok <- 128357
max_year_vostok <- 138193
# filter data set + plot
vostok_temp_subset <- vostok_temp %>%
filter(age_ice >= min_year_vostok & age_ice <= max_year_vostok)
ggplot(vostok_temp_subset, aes(x = age_ice/1000, y = temperature)) +
geom_line(color = "blue", size = 1) +
geom_smooth(method = "lm", color = "red", se = FALSE) +
labs(x = "thousand years before present", y = "Temperature variation [C]",
title = "Temperature change recorded in Vostok ice core.",
caption = "Data: Carbon Dioxide Information Analysis Center (CDIAC)") +
theme_standard
# fit linear regression
score_model <- lm(temperature ~ age_ice, data = vostok_temp_subset)
# view summary of results
summary(score_model)
# load dataset
vostok_ice <- read_delim("data/vostok_ice.txt", delim = "\t",
skip = 21,
col_names = c("depth", "age_ice", "age_air", "CO2"))
View(vostok_ice)
