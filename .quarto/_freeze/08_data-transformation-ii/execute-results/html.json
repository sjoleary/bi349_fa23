{
  "hash": "2110b984a954470383e2821d27b98030",
  "result": {
    "markdown": "---\noutput: html_document\neditor_options: \n  chunk_output_type: console\n---\n\n\n# Data Transformation: \n\n\n\n\n\n\n**Learning Objectives**\n\nAfter completing this lab you should be able to \n\n* use `mutate()` to add new columns.\n* use `group_by()` to group rows.\n* use `summarize()` to calculate summary statistics.\n\nFor each of our modules we will have a project-folder with an `Rproject`, `*.qmd`-files, and sub-directories for data, scripts, and results as described in our `Rproject` Tutorial. You should have a directory on your Desktop or Documents folder on your laptop (name it something like `bi349`) as a home directory for all of our project folders this semester. \n\n[You should have already downloaded the project directory for this module ](https://drive.google.com/drive/folders/1Sh4mtvdii1k_vU4-mfvgIGwJsZvo8MOt?usp=sharing), make sure the directory is unzipped and move it to your `bi328` directory. You can open the `Rproj` for this module either by double clicking on it which will launch `Rstudio` or by opening `Rstudio` and then using `File > Open Project` or by clicking on the `Rproject` icon in the top right of your program window and selecting `Open Project`. \n\nOnce you have opened a project you should see the project name in the top right corner^[Pro tip: If you run into issues where a quarto document won't render or file paths aren't working (especially if things were working previously) one of your first steps should be to double check that the correct `Rproj` is loaded.].\n\nThere should be a document names `08_data-transformation-ii.qmd` in your project directory. Use that file to work through this tutorial - you will hand in your rendered (\"knitted\") `quarto` file as your homework assignment. So, first thing in the `YAML` header, change the author to your name. You will use this `quarto` document to record your answers. Remember to use comments to annotate your code; at minimum you should have one comment per code set^[You should do this whether you are adding code yourself or using code from our manual, even if it isn't commented in the manual... especially when the code is already included for you, add comments to describe how the function works/what it does as we introduce it during the participatory coding session so you can refer back to it.] you may of course add as many comments as you need to be able to recall what you did]. Similarly, take notes in the document as we discuss discussion/reflection questions but make sure that you go back and clean them up for \"public consumption\".\n\nLet's start by loading the packages we will need for this activity.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load libraries\nlibrary(knitr)\nlibrary(tidyverse)\n```\n:::\n\n\nAnd we will want to make sure that we have read in our data set as a dataframe.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# read catch data\ncatch <- read_delim(\"data/longline_catchdata.txt\", delim = \"\\t\")\n```\n:::\n\n\n\n## Adding new variables\n\nSo,turns out selecting columns and filtering based on content in rows is pretty straightforward. \n\nBut frequently when we are processing our raw data sets we end up wanting to compute additional metrics or use the existing raw data to create new categories.\n\nThe function `mutate()` can be used to create new columns. Frequently, this is done based on columns already existing in the data frame. This is a very powerful function with endless possibilities, but we are going to stick to some of the basics for now^[Rest assured if your answer is \"Oh, could I ...\" the answer is \"Yes\".].\n\nLet's say you wanted create a column that contained the difference between the fork length and the stretch total length^[By default `mutate()` appends (adds) the new column as the last column. So we can see our results better we'll used `select()` to move it to be the first column in the dataframe)]:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncatch %>%\n  mutate(difference = STL - FL) %>%\n  select(difference, everything())\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2,325 × 13\n   difference Site      Species Sex   Observed_Stage   PCL    FL   STL Hook_Size\n        <dbl> <chr>     <chr>   <chr> <chr>          <dbl> <dbl> <dbl>     <dbl>\n 1         66 Aransas_… Bagre_… U     <NA>              NA   287   353        10\n 2         70 Aransas_… Bagre_… U     <NA>              NA   425   495        10\n 3         86 Aransas_… Bagre_… U     <NA>              NA   416   502        15\n 4         91 Aransas_… Bagre_… U     <NA>              NA   416   507        10\n 5         92 Aransas_… Bagre_… U     <NA>              NA   418   510        15\n 6         81 Aransas_… Bagre_… U     <NA>              NA   434   515        10\n 7         93 Aransas_… Bagre_… U     <NA>              NA   427   520        15\n 8         86 Aransas_… Bagre_… U     <NA>              NA   446   532        10\n 9         73 Aransas_… Bagre_… U     <NA>              NA   465   538        10\n10         89 Aransas_… Bagre_… U     <NA>              NA   450   539        10\n# ℹ 2,315 more rows\n# ℹ 4 more variables: Set <dbl>, Day <dbl>, Month <dbl>, Year <dbl>\n```\n:::\n:::\n\n\nYou should now have a column called `difference` at the end of the data frame^[Instead of `-` to substract, you can other mathematical operators such as `+` to add , `*` to multiple, and `/` to divide values when creating a new column.].\n\n::: {.callout-note icon=false}\n\n## {{< fa clipboard-question >}}   Give it a whirl\n\nHow would you create a new column called ratio, that is the ratio of the fork to stretch total length?\n\n:::\n\n\nYou can also create a column that contains a logical value (`TRUE`/`FALSE`). For example we might need a column that indicates if the Sex is unknown.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncatch %>%\n  mutate(unknown_sex = Sex == \"U\") %>%\n  select(unknown_sex, everything())\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2,325 × 13\n   unknown_sex Site     Species Sex   Observed_Stage   PCL    FL   STL Hook_Size\n   <lgl>       <chr>    <chr>   <chr> <chr>          <dbl> <dbl> <dbl>     <dbl>\n 1 TRUE        Aransas… Bagre_… U     <NA>              NA   287   353        10\n 2 TRUE        Aransas… Bagre_… U     <NA>              NA   425   495        10\n 3 TRUE        Aransas… Bagre_… U     <NA>              NA   416   502        15\n 4 TRUE        Aransas… Bagre_… U     <NA>              NA   416   507        10\n 5 TRUE        Aransas… Bagre_… U     <NA>              NA   418   510        15\n 6 TRUE        Aransas… Bagre_… U     <NA>              NA   434   515        10\n 7 TRUE        Aransas… Bagre_… U     <NA>              NA   427   520        15\n 8 TRUE        Aransas… Bagre_… U     <NA>              NA   446   532        10\n 9 TRUE        Aransas… Bagre_… U     <NA>              NA   465   538        10\n10 TRUE        Aransas… Bagre_… U     <NA>              NA   450   539        10\n# ℹ 2,315 more rows\n# ℹ 4 more variables: Set <dbl>, Day <dbl>, Month <dbl>, Year <dbl>\n```\n:::\n:::\n\n\nYou should know have a column called `unknown_sex` where if the animal that was caught was not sexed contains the value `TRUE`, if it was identified as male or female it would say `FALSE`.\n\n::: {.callout-note icon=false}\n\n## {{< fa clipboard-question >}}   Give it a whirl\n\nHow would you create a new column called post_2017 that is TRUE if fish were caught after 2017?\n\n:::\n\n\n::: {.column-margin}\n\nFor that last problem, a \"conditional mutate\" using an `ifelse` statement (if this then do that, else do that) could have come in handy. Another option is `case_when()` which allows you to create multiple sets of conditions as opposed to `ifelse` which sets up a `TRUE`/`FALSE` dichotomy (file this information away for \"maybe useful later\").\n\n:::\n\n\n## `group_by()` and `mutate()`\n\nMany problems in data science require you to split your data set into subsets according to some grouping variable, apply a function, and then combine the results. `dplyr` is designed to make this straightforward; you have already sen an example of this while you were learning about `filter()`. \n\nSimilarly, you can combine `mutate()` with `group_by()`.\n\n::: {.column-margin}\n\nThe function `mean()` will calculate the mean value of a vector of numbers, the argument `na.rm=TRUE` tells the function to ignore any `NA`-values in the data set.\n\n:::\n\n\nFor example, let's say you wanted to create a column that is the difference between the fork length of an individual and the mean fork length of *that species*.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncatch %>%\n  group_by(Species) %>%\n  mutate(diff_mean = FL-mean(FL, na.rm = TRUE))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2,325 × 13\n# Groups:   Species [14]\n   Site     Species Sex   Observed_Stage   PCL    FL   STL Hook_Size   Set   Day\n   <chr>    <chr>   <chr> <chr>          <dbl> <dbl> <dbl>     <dbl> <dbl> <dbl>\n 1 Aransas… Bagre_… U     <NA>              NA   287   353        10     1    28\n 2 Aransas… Bagre_… U     <NA>              NA   425   495        10     1    28\n 3 Aransas… Bagre_… U     <NA>              NA   416   502        15     1    28\n 4 Aransas… Bagre_… U     <NA>              NA   416   507        10     1    28\n 5 Aransas… Bagre_… U     <NA>              NA   418   510        15     1    28\n 6 Aransas… Bagre_… U     <NA>              NA   434   515        10     1    28\n 7 Aransas… Bagre_… U     <NA>              NA   427   520        15     1    28\n 8 Aransas… Bagre_… U     <NA>              NA   446   532        10     1    28\n 9 Aransas… Bagre_… U     <NA>              NA   465   538        10     1    28\n10 Aransas… Bagre_… U     <NA>              NA   450   539        10     1    28\n# ℹ 2,315 more rows\n# ℹ 3 more variables: Month <dbl>, Year <dbl>, diff_mean <dbl>\n```\n:::\n:::\n\n\n::: {.callout-note icon=false}\n\n## {{< fa clipboard-question >}}   Give it a whirl\n\nHow would you create a new column called that contains the difference between the fork length of an individual and the mean fork length of that species for each month?\n\n:::\n\n\n## Create new `data.frame` based on another\n\nNot infrequently we are more interested in summary (descriptive) stats of a data set rather than all the raw data - `Tidyverse` got you covered with the function `summarize()`.\n\nFor example, we might want to calculate the mean and standard deviation of the measured fork length.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncatch %>%\n  summarize(mean_FL = mean(FL, na.rm = TRUE),\n            sd_FL = sd(FL, na.rm = TRUE))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 2\n  mean_FL sd_FL\n    <dbl> <dbl>\n1    406.  103.\n```\n:::\n:::\n\n\n::: {.column-margin}\n\nRemember, that earlier we've have used the function `max()` to obtain the largest value in a vector.\n\n:::\n\n\n::: {.callout-note icon=false}\n\n## {{< fa clipboard-question >}}   Give it a whirl\n\nHow could you use summarize to get the maximum forklength?\n\n:::\n\n\nThat's cool but really we could have also just used \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmean(catch$FL, na.rm = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 405.9179\n```\n:::\n\n```{.r .cell-code}\nmax(catch$FL, na.rm = TRUE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 1140\n```\n:::\n:::\n\n\nto get that information, since we are only interested in one column (vector).\n\n`summarize()` becomes especially powerful once we leverage `group_by()` to start calculating summary stats for entries grouped by a grouping variable.\n\nFor example we can calculate summary stats by species and generate a table to include in a report.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncatch %>%\n  group_by(Species) %>%\n  summarize(mean_FL = mean(FL, na.rm = TRUE),\n           median_FL = median(FL, na.rm = TRUE),\n           max_FL = max(FL, na.rm = TRUE),\n           min_FL = min(FL, na.rm = TRUE),\n           sd_FL = sd(FL, na.rm = TRUE)) %>%\n  ungroup()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 14 × 6\n   Species                    mean_FL median_FL max_FL min_FL sd_FL\n   <chr>                        <dbl>     <dbl>  <dbl>  <dbl> <dbl>\n 1 Bagre_marinus                 433.      445     575     45  65.4\n 2 Carcharhinus_brevipinna       644.      648     900    489  69.2\n 3 Carcharhinus_leucas           769       702    1140    624 167. \n 4 Carcharhinus_limbatus         613.      579     757    538 101. \n 5 Carcharhinus_porosus          415       415     415    415  NA  \n 6 Hypanus_americanus            NaN        NA    -Inf    Inf  NA  \n 7 Hypanus_sabina                NaN        NA    -Inf    Inf  NA  \n 8 Rhinoptera_bonasus            NaN        NA    -Inf    Inf  NA  \n 9 Rhizoprionodon_terraenovae    412       396     637    306  73.6\n10 Sciades_felis                 299.      297     480    102  41.9\n11 Sciaenops_ocellatus           793       793     841    745  67.9\n12 Sphyrna_lewini                471.      548.    578    210 174. \n13 Sphyrna_tiburo                622.      605     861    370 114. \n14 Synodus_foetens               173       173     173    173  NA  \n```\n:::\n:::\n\n\n\n::: {.callout-note icon=false}\n\n## {{< fa clipboard-question >}}   Consider this\n\nIf you look closely you should see that you are getting a few NA, NaN, -Inf, and Inf values - any guesses why? You might want to pull up the catch data frame in the view panel to see what is going on with those species.\n\n:::\n\n::: {.callout-note icon=false}\n\n## {{< fa clipboard-question >}}   Give it a whirl\n\nHow could you use `summarize()` to calculate a range of summary stats for the stretch total length for individuals grouped by sex?\n\n:::\n\n\nSo far, we have been manipulating our data frame using code and printing it directly to the console (and our quarto document). This can be useful for example to generate tables for reports. However, in many cases we want to create a new object that has been manipulated according to our code and then we will further process, visualize, or analyze that dataframe down the line.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary <- catch %>%\n  group_by(Species) %>%\n  summarize(mean_FL = mean(FL, na.rm = TRUE),\n           median_FL = median(FL, na.rm = TRUE),\n           max_FL = max(FL, na.rm = TRUE),\n           min_FL = min(FL, na.rm = TRUE),\n           sd_FL = sd(FL, na.rm = TRUE)) %>%\n  ungroup()\n```\n:::\n\n\nWhen you execute this code, you'll notice that the code (and probably a warning) is printed to the console but there is no output. Instead, if you look at the environment in the bottom left panel you should now see a new object called `summary`. Per usual, you can pull that up in the Editor/View pane (top left) using either `View(summary)` in the console or by clicking on the object in the environment.\n\nYou will be presenting results in reports over the course of the semester, when you `knit` an `quarto` file you will get tables formatted in a standard way according to defaults in the resulting `html` file. If you want finer control over the output, you can use the `kable()` function. This will allow you to further format the table, for example, you may specify the number of digits printed using the argument `digits = `.\n\nBy adding a chunk options for a label as `#| label: tbl-sum-stats` and table caption as `#| tbl-cap: \"Summary statistics for the forklength of each species`, you can further modify the output that adheres to typical reporting standards for reports and research articles.\n\n\n::: {#tbl-sum-stats .cell tbl-cap='Summary statistics for the forklength of each species in the catch data'}\n\n```{.r .cell-code}\nkable(\n  summary,\n  digits = 1\n)\n```\n\n::: {.cell-output-display}\n|Species                    | mean_FL| median_FL| max_FL| min_FL| sd_FL|\n|:--------------------------|-------:|---------:|------:|------:|-----:|\n|Bagre_marinus              |   433.4|     445.0|    575|     45|  65.4|\n|Carcharhinus_brevipinna    |   643.7|     648.0|    900|    489|  69.2|\n|Carcharhinus_leucas        |   769.0|     702.0|   1140|    624| 167.3|\n|Carcharhinus_limbatus      |   613.2|     579.0|    757|    538| 101.0|\n|Carcharhinus_porosus       |   415.0|     415.0|    415|    415|    NA|\n|Hypanus_americanus         |     NaN|        NA|   -Inf|    Inf|    NA|\n|Hypanus_sabina             |     NaN|        NA|   -Inf|    Inf|    NA|\n|Rhinoptera_bonasus         |     NaN|        NA|   -Inf|    Inf|    NA|\n|Rhizoprionodon_terraenovae |   412.0|     396.0|    637|    306|  73.6|\n|Sciades_felis              |   298.9|     297.0|    480|    102|  41.9|\n|Sciaenops_ocellatus        |   793.0|     793.0|    841|    745|  67.9|\n|Sphyrna_lewini             |   470.8|     547.5|    578|    210| 174.4|\n|Sphyrna_tiburo             |   621.5|     605.0|    861|    370| 114.4|\n|Synodus_foetens            |   173.0|     173.0|    173|    173|    NA|\n:::\n:::\n\n\n\n## Combining verbs\n\nWe've already combined most of our `dplyr` verbs with `group_by()`. \n\nWhen you are wrangling data you will find that making use of the pipe (`%>%`) to combine `select()`, `filter()`, `mutate()`, and `summarize()` as a series of commands will be necessary to get your data set in the correct format and further process it.\n\n::: {.callout-note icon=false}\n\n## {{< fa clipboard-question >}}   Give it a whirl\n\nExecutre the following the code chunk. Then describe what each line is doing to manipulate the data frame.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncatch %>%\n  select(-PCL, -Hook_Size) %>%\n  separate(Species, into = c(\"genus\", \"species\"), remove = TRUE) %>%\n  unite(Date, Day, Month, Year) %>%\n  filter(genus == \"Carcharhinus\" & Sex %in% c(\"F\", \"M\")) %>%\n  group_by(Site, genus, species, Sex) %>%\n  filter(FL == max(FL)) %>%\n  arrange(species)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 11 × 9\n# Groups:   Site, genus, species, Sex [11]\n   Site               genus species Sex   Observed_Stage    FL   STL   Set Date \n   <chr>              <chr> <chr>   <chr> <chr>          <dbl> <dbl> <dbl> <chr>\n 1 Aransas_Bay        Carc… brevip… M     <NA>             640   792     3 22_9…\n 2 Redfish_Bay        Carc… brevip… F     <NA>             900  1090     1 16_6…\n 3 Redfish_Bay        Carc… brevip… M     <NA>             882  1092     2 16_6…\n 4 Corpus_Christi_Bay Carc… brevip… M     <NA>             699   860     1 25_1…\n 5 Corpus_Christi_Bay Carc… brevip… F     <NA>             704   880     4 2_10…\n 6 Aransas_Bay        Carc… leucas  F     <NA>            1140  1410     1 25_5…\n 7 Corpus_Christi_Bay Carc… leucas  F     YOY              694   854     2 10_6…\n 8 Aransas_Bay        Carc… leucas  M     <NA>             812   912     4 22_9…\n 9 Redfish_Bay        Carc… leucas  M     <NA>             840  1010     3 29_9…\n10 Aransas_Bay        Carc… limbat… F     <NA>             757   940     2 22_6…\n11 Corpus_Christi_Bay Carc… limbat… M     <NA>             610   770     2 30_8…\n```\n:::\n:::\n\n\n:::\n\n\nGenerate the code that will manipulate the data frame as follows^[some bullet points may require more than one line of code; you do not have to perform the steps in the sequence presented, play around a little bit to see how to code this more efficiently]:\n\n::: {.callout-note icon=false}\n\n## {{< fa clipboard-question >}}   Give it a whirl\n\nChallenge 1:\n\n* order columns so Day, Month, Year, Set are at the beginning.\n* retain all male individuals in the genus Carcharhinus.\n* get rid of columns containing information on observed stage, precaudal length, and hook size\n\n:::\n\n\n::: {.callout-note icon=false}\n\n## {{< fa clipboard-question >}}   Give it a whirl\n\nChallenge 2:\n\n* create a new variable called Set_ID consisting of Day, Month, Year, and Set number.\n* determine the number of individuals per species per set^[There is a function called `n()` that allows us to count rows fulfilling a specific condition].\n\n\n:::\n\n\n\n::: {.callout-note icon=false}\n\n## {{< fa clipboard-question >}}   Give it a whirl\n\n\nChallenge 3:\n\n* remove all gafftops\n* calculate mean forklength for each species by sex and month of the year.\n\n:::\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}